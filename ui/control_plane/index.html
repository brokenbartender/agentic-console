<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agentic Control Plane</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap");

      :root {
        --bg: #f6f3ef;
        --bg2: #fff7ee;
        --ink: #141414;
        --muted: #6b6b6b;
        --accent: #1b7f6b;
        --accent-2: #ff8a3d;
        --accent-3: #3c5ccf;
        --card: #ffffff;
        --line: #e6ded6;
        --shadow: 0 8px 30px rgba(20, 20, 20, 0.08);
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at 12% 10%, #fff1e0 0%, #f6f3ef 38%, #f1f7f5 100%);
      }

      .app {
        display: grid;
        grid-template-rows: auto 1fr;
        min-height: 100vh;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 28px;
        background: linear-gradient(120deg, #fff7ee 0%, #fef4e6 50%, #f1fbf7 100%);
        border-bottom: 1px solid var(--line);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
        font-weight: 700;
        font-size: 20px;
      }

      .brand .dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: conic-gradient(from 120deg, var(--accent), var(--accent-2), var(--accent-3), var(--accent));
        box-shadow: 0 0 0 4px rgba(27, 127, 107, 0.15);
      }

      .status {
        display: flex;
        gap: 16px;
        font-size: 14px;
        color: var(--muted);
        align-items: center;
      }

      .persona {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 6px 10px;
        background: #fff;
        font-family: "Space Grotesk", system-ui, sans-serif;
      }

      .pill {
        padding: 6px 12px;
        border-radius: 999px;
        background: #ffffff;
        border: 1px solid var(--line);
        box-shadow: var(--shadow);
      }

      main {
        padding: 24px;
        display: grid;
        gap: 20px;
        grid-template-columns: 1.2fr 1fr 0.9fr;
        grid-template-rows: auto 1fr auto;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }

      .card h3 {
        margin: 0 0 12px 0;
        font-size: 16px;
      }

      .command {
        grid-column: 1 / 2;
      }

      .command textarea {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        font-family: "IBM Plex Mono", monospace;
        min-height: 120px;
      }

      .command .actions {
        display: flex;
        gap: 10px;
        margin-top: 12px;
      }

      button {
        border: none;
        border-radius: 12px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
      }

      .primary {
        background: var(--accent);
        color: #fff;
      }

      .secondary {
        background: #f4efe9;
        border: 1px solid var(--line);
      }

      .artifacts {
        grid-column: 2 / 4;
      }

      .artifacts pre {
        font-family: "IBM Plex Mono", monospace;
        white-space: pre-wrap;
        background: #f8f6f3;
        border-radius: 12px;
        padding: 12px;
        border: 1px solid var(--line);
      }

      .artifact-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .artifact-view {
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
        overflow: hidden;
      }

      .artifact-view iframe {
        width: 100%;
        height: 240px;
        border: none;
      }

      .events {
        grid-column: 1 / 3;
        max-height: 380px;
        overflow: auto;
      }

      .event {
        border-bottom: 1px dashed var(--line);
        padding: 10px 0;
        font-size: 13px;
      }

      .a2a {
        grid-column: 3 / 4;
        max-height: 380px;
        overflow: auto;
        font-size: 13px;
      }

      .tools {
        grid-column: 1 / 4;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
      }

      .tool {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        background: #fffaf5;
      }

      .tool .risk {
        font-size: 12px;
        color: var(--muted);
      }

      .mono {
        font-family: "IBM Plex Mono", monospace;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div class="brand">
          <div class="dot"></div>
          Agentic Control Plane
        </div>
        <div class="status">
          <div class="pill" id="status-metrics">Metrics: --</div>
          <div class="pill" id="status-events">Events: --</div>
          <select class="persona" id="persona" onchange="setPersona()">
            <option value="">Persona: Default</option>
            <option value="Coder">Coder</option>
            <option value="Researcher">Researcher</option>
            <option value="VLA">VLA Operator</option>
            <option value="Reviewer">Reviewer</option>
          </select>
        </div>
      </header>
      <main>
        <div class="card command">
          <h3>Command</h3>
          <textarea id="command" placeholder="Try: agent build a data ingestion plan"></textarea>
          <div class="actions">
            <button class="primary" onclick="sendCommand()">Plan</button>
            <button class="secondary" onclick="approve()">Approve</button>
            <button class="secondary" onclick="approveStep()">Approve Step</button>
          </div>
          <div id="plan" class="mono" style="margin-top:12px; font-size:12px;"></div>
        </div>

        <div class="card artifacts">
          <h3>Artifacts</h3>
          <div class="artifact-tabs">
            <button class="secondary" onclick="showArtifact('preview')">Preview</button>
            <button class="secondary" onclick="showArtifact('raw')">Raw</button>
          </div>
          <div class="artifact-view" id="artifact-preview" style="display:none;">
            <iframe id="artifact-frame" title="artifact preview"></iframe>
          </div>
          <pre id="artifacts">No artifacts yet.</pre>
        </div>

        <div class="card events">
          <h3>Event Stream</h3>
          <div id="events"></div>
        </div>

        <div class="card a2a">
          <h3>A2A Feed</h3>
          <div id="a2a"></div>
        </div>

        <div class="card tools">
          <h3 style="grid-column:1/-1;">Tools</h3>
          <div id="tools" class="tools"></div>
        </div>
      </main>
    </div>

    <script>
      async function sendCommand() {
        const cmd = document.getElementById("command").value.trim();
        if (!cmd) return;
        const res = await fetch("/api/command", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command: cmd }),
        });
        const data = await res.json();
        document.getElementById("plan").textContent = data.plan || JSON.stringify(data, null, 2);
      }

      async function approve() {
        const planText = document.getElementById("plan").textContent || "";
        const match = planText.match(/\"run_id\"\\s*:\\s*\"([^\"]+)\"/);
        const runId = match ? match[1] : "";
        if (!runId) return;
        await fetch("/api/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ run_id: runId }),
        });
      }

      async function approveStep() {
        await fetch("/api/approve_step", { method: "POST", headers: { "Content-Type": "application/json" } });
      }

      async function setPersona() {
        const persona = document.getElementById("persona").value;
        if (!persona) return;
        await fetch("/api/command", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command: `profile ${persona}` }),
        });
      }

      function renderEvents(items) {
        const el = document.getElementById("events");
        el.innerHTML = items.map((e) => {
          const payload = JSON.stringify(e.payload || {}, null, 2);
          return `<div class="event"><strong>${e.event_type}</strong> <div class="mono">${payload}</div></div>`;
        }).join("");
      }

      function renderA2A(items) {
        const el = document.getElementById("a2a");
        el.innerHTML = items.map((m) => {
          return `<div class="event"><strong>${m.sender}</strong> â†’ ${m.receiver}<div class="mono">${m.message}</div></div>`;
        }).join("");
      }

      function renderTools(items) {
        const el = document.getElementById("tools");
        el.innerHTML = items.map((t) => {
          return `<div class="tool"><div><strong>${t.name}</strong></div><div class="risk">risk: ${t.risk || "n/a"}</div><div class="mono">${t.arg_hint || ""}</div></div>`;
        }).join("");
      }

      function extractArtifacts(events) {
        for (const e of events) {
          if (!e || !e.payload) continue;
          const payload = e.payload.payload || e.payload;
          const text = typeof payload === "string" ? payload : JSON.stringify(payload);
          const match = text.match(/```(html|svg)([\\s\\S]*?)```/i);
          if (match) {
            return { type: match[1].toLowerCase(), content: match[2].trim() };
          }
        }
        return null;
      }

      function showArtifact(mode) {
        const preview = document.getElementById("artifact-preview");
        const raw = document.getElementById("artifacts");
        if (mode === "preview") {
          preview.style.display = "block";
          raw.style.display = "none";
        } else {
          preview.style.display = "none";
          raw.style.display = "block";
        }
      }

      async function refresh() {
        const cockpit = await fetch("/api/cockpit").then((r) => r.json());
        renderEvents(cockpit.events || []);
        renderA2A(cockpit.a2a || []);
        const metrics = cockpit.metrics || {};
        document.getElementById("status-metrics").textContent = `Metrics: ${Object.keys(metrics).length}`;
        document.getElementById("status-events").textContent = `Events: ${cockpit.events ? cockpit.events.length : 0}`;
        const tools = await fetch("/api/tools").then((r) => r.json());
        renderTools(tools || []);

        const artifact = extractArtifacts(cockpit.events || []);
        if (artifact) {
          document.getElementById("artifacts").textContent = artifact.content;
          document.getElementById("artifact-frame").srcdoc = artifact.content;
          showArtifact("preview");
        }
      }

      setInterval(refresh, 2000);
      refresh();
    </script>
  </body>
</html>
