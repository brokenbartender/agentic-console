<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agentic Control Plane</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap");

      :root {
        --bg: #f6f3ef;
        --bg2: #fff7ee;
        --ink: #141414;
        --muted: #6b6b6b;
        --accent: #1b7f6b;
        --accent-2: #ff8a3d;
        --accent-3: #3c5ccf;
        --card: #ffffff;
        --line: #e6ded6;
        --shadow: 0 8px 30px rgba(20, 20, 20, 0.08);
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at 12% 10%, #fff1e0 0%, #f6f3ef 38%, #f1f7f5 100%);
      }

      .app {
        display: grid;
        grid-template-rows: auto 1fr;
        min-height: 100vh;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 28px;
        background: linear-gradient(120deg, #fff7ee 0%, #fef4e6 50%, #f1fbf7 100%);
        border-bottom: 1px solid var(--line);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
        font-weight: 700;
        font-size: 20px;
      }

      .brand .dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: conic-gradient(from 120deg, var(--accent), var(--accent-2), var(--accent-3), var(--accent));
        box-shadow: 0 0 0 4px rgba(27, 127, 107, 0.15);
      }

      .status {
        display: flex;
        gap: 16px;
        font-size: 14px;
        color: var(--muted);
        align-items: center;
      }

      .persona {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 6px 10px;
        background: #fff;
        font-family: "Space Grotesk", system-ui, sans-serif;
      }

      .pill {
        padding: 6px 12px;
        border-radius: 999px;
        background: #ffffff;
        border: 1px solid var(--line);
        box-shadow: var(--shadow);
      }

      main {
        padding: 24px;
        display: grid;
        gap: 20px;
        grid-template-columns: 1.2fr 1fr 0.9fr;
        grid-template-rows: auto 1fr auto;
      }

      .layout {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 20px;
      }

      .sidebar {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 16px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .sidebar h4 {
        margin: 0 0 8px 0;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .persona-list button {
        width: 100%;
        text-align: left;
        margin-bottom: 8px;
      }

      .persona-list button.active {
        background: var(--accent-3);
        color: #fff;
      }

      .session {
        padding: 8px;
        border: 1px dashed var(--line);
        border-radius: 10px;
        font-size: 12px;
        margin-bottom: 6px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }

      .card h3 {
        margin: 0 0 12px 0;
        font-size: 16px;
      }

      .command {
        grid-column: 1 / 2;
      }

      .command textarea {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        font-family: "IBM Plex Mono", monospace;
        min-height: 120px;
      }

      .command .actions {
        display: flex;
        gap: 10px;
        margin-top: 12px;
      }

      button {
        border: none;
        border-radius: 12px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
      }

      .primary {
        background: var(--accent);
        color: #fff;
      }

      .secondary {
        background: #f4efe9;
        border: 1px solid var(--line);
      }

      .artifacts {
        grid-column: 2 / 4;
      }

      .artifacts pre {
        font-family: "IBM Plex Mono", monospace;
        white-space: pre-wrap;
        background: #f8f6f3;
        border-radius: 12px;
        padding: 12px;
        border: 1px solid var(--line);
      }

      .artifact-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .artifact-view {
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
        overflow: hidden;
      }

      .artifact-view iframe {
        width: 100%;
        height: 240px;
        border: none;
      }

      .sheet {
        position: fixed;
        top: 0;
        right: 0;
        width: 360px;
        height: 100%;
        background: #fff;
        border-left: 1px solid var(--line);
        box-shadow: var(--shadow);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        padding: 16px;
        z-index: 10;
        overflow: auto;
      }

      .sheet.open {
        transform: translateX(0);
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.15);
        display: none;
        z-index: 9;
      }

      .overlay.show {
        display: block;
      }

      .brain-view {
        position: fixed;
        inset: 0;
        background: rgba(20,20,20,0.7);
        display: none;
        z-index: 20;
        align-items: center;
        justify-content: center;
      }

      .brain-view.show {
        display: flex;
      }

      .brain-canvas {
        background: #fff;
        border-radius: 16px;
        padding: 16px;
        width: 80%;
        max-width: 900px;
      }

      .hud {
        position: fixed;
        bottom: 18px;
        right: 18px;
        width: 240px;
        height: 160px;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
        border: 1px solid var(--line);
        box-shadow: var(--shadow);
        z-index: 8;
      }

      .hud img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .events {
        grid-column: 1 / 3;
        max-height: 380px;
        overflow: auto;
      }

      .event {
        border-bottom: 1px dashed var(--line);
        padding: 10px 0;
        font-size: 13px;
      }

      .ui-card {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        background: #f2f7ff;
        margin-top: 8px;
      }

      .ui-card h4 {
        margin: 0 0 6px 0;
      }

      .ui-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .a2a {
        grid-column: 3 / 4;
        max-height: 380px;
        overflow: auto;
        font-size: 13px;
      }

      .tools {
        grid-column: 1 / 4;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
      }

      .tool {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        background: #fffaf5;
      }

      .tool .risk {
        font-size: 12px;
        color: var(--muted);
      }

      .source-card {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 10px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
        margin-bottom: 8px;
      }

      .source-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: #f4efe9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: var(--accent-3);
      }

      .source-meta {
        font-size: 12px;
        color: var(--muted);
      }

      .mono {
        font-family: "IBM Plex Mono", monospace;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div class="brand">
          <div class="dot"></div>
          Agentic Control Plane
        </div>
        <div class="status">
          <div class="pill" id="status-metrics">Metrics: --</div>
          <div class="pill" id="status-events">Events: --</div>
          <select class="persona" id="persona" onchange="setPersona()">
            <option value="">Persona: Default</option>
            <option value="Coder">Coder</option>
            <option value="Researcher">Researcher</option>
            <option value="VLA">VLA Operator</option>
            <option value="Reviewer">Reviewer</option>
          </select>
          <button class="secondary" onclick="toggleSheet()">Config</button>
          <button class="secondary" onclick="toggleBrain()">Brain View</button>
        </div>
      </header>
      <main class="layout">
        <aside class="sidebar">
          <div>
            <h4>Agent Market</h4>
            <div class="persona-list" id="persona-list"></div>
          </div>
          <div>
            <h4>Sessions</h4>
            <div id="session-list"></div>
          </div>
        </aside>
        <div>
        <div class="card command">
          <h3>Command</h3>
          <textarea id="command" placeholder="Try: agent build a data ingestion plan"></textarea>
          <div class="actions">
            <button class="primary" onclick="sendCommand()">Plan</button>
            <button class="secondary" onclick="approve()">Approve</button>
            <button class="secondary" onclick="approveStep()">Approve Step</button>
          </div>
          <div id="plan" class="mono" style="margin-top:12px; font-size:12px;"></div>
        </div>

        <div class="card artifacts">
          <h3>Artifacts</h3>
          <div class="artifact-tabs">
            <button class="secondary" onclick="showArtifact('preview')">Preview</button>
            <button class="secondary" onclick="showArtifact('raw')">Raw</button>
          </div>
          <div class="artifact-view" id="artifact-preview" style="display:none;">
            <iframe id="artifact-frame" title="artifact preview"></iframe>
          </div>
          <pre id="artifacts">No artifacts yet.</pre>
        </div>

        <div class="card events">
          <h3>Event Stream</h3>
          <div id="events"></div>
        </div>

        <div class="card a2a">
          <h3>A2A Feed</h3>
          <div id="a2a"></div>
        </div>

        <div class="card">
          <h3>Terminal Output</h3>
          <pre id="terminal" class="mono">No output yet.</pre>
        </div>

        <div class="card">
          <h3>Sources</h3>
          <div id="sources"></div>
        </div>

        <div class="card tools">
          <h3 style="grid-column:1/-1;">Tools</h3>
          <div id="tools" class="tools"></div>
        </div>
        </div>
      </main>
    </div>
    <div class="overlay" id="overlay" onclick="toggleSheet(false)"></div>
    <div class="sheet" id="sheet">
      <h3>Configuration</h3>
      <textarea id="config-edit" class="mono" style="width:100%; height:300px;"></textarea>
      <div class="actions" style="margin-top:10px;">
        <button class="primary" onclick="saveConfig()">Save</button>
        <button class="secondary" onclick="loadConfig()">Reload</button>
      </div>
    </div>
    <div class="brain-view" id="brain">
      <div class="brain-canvas">
        <h3>Agent Mesh</h3>
        <svg id="brain-svg" width="100%" height="420"></svg>
        <button class="secondary" onclick="toggleBrain(false)">Close</button>
      </div>
    </div>
    <div class="hud">
      <img id="hud-image" alt="VLA HUD" />
    </div>

    <script>
      async function sendCommand() {
        const cmd = document.getElementById("command").value.trim();
        if (!cmd) return;
        const res = await fetch("/api/command", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command: cmd }),
        });
        const data = await res.json();
        document.getElementById("plan").textContent = data.plan || JSON.stringify(data, null, 2);
      }

      async function approve() {
        const planText = document.getElementById("plan").textContent || "";
        const match = planText.match(/\"run_id\"\\s*:\\s*\"([^\"]+)\"/);
        const runId = match ? match[1] : "";
        if (!runId) return;
        await fetch("/api/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ run_id: runId }),
        });
      }

      async function approveStep() {
        await fetch("/api/approve_step", { method: "POST", headers: { "Content-Type": "application/json" } });
      }

      async function setPersona() {
        const persona = document.getElementById("persona").value;
        if (!persona) return;
        await fetch("/api/command", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command: `profile ${persona}` }),
        });
      }

      function renderEvents(items) {
        const el = document.getElementById("events");
        el.innerHTML = items.map((e) => {
          const payload = JSON.stringify(e.payload || {}, null, 2);
          const ui = extractUI(e.payload || {});
          const uiHtml = ui ? renderUICard(ui) : "";
          return `<details class="event"><summary><strong>${e.event_type}</strong></summary><div class="mono">${payload}</div>${uiHtml}</details>`;
        }).join("");
      }

      function renderA2A(items) {
        const el = document.getElementById("a2a");
        el.innerHTML = items.map((m) => {
          return `<div class="event"><strong>${m.sender}</strong> → ${m.receiver}<div class="mono">${m.message}</div></div>`;
        }).join("");
      }

      function renderTools(items) {
        const el = document.getElementById("tools");
        el.innerHTML = items.map((t) => {
          return `<div class="tool"><div><strong>${t.name}</strong></div><div class="risk">risk: ${t.risk || "n/a"}</div><div class="mono">${t.arg_hint || ""}</div></div>`;
        }).join("");
      }

      async function renderPersonaList() {
        let personas = [];
        try {
          personas = await fetch("/api/roles").then((r) => r.json());
        } catch {}
        if (!personas.length) {
          personas = [
            { id: "Coder", label: "Coder Agent" },
            { id: "Researcher", label: "Research Agent" },
            { id: "VLA", label: "VLA Agent" },
            { id: "Reviewer", label: "Reviewer Agent" },
            { id: "Legal", label: "Legal Agent" },
          ];
        }
        const el = document.getElementById("persona-list");
        const current = document.getElementById("persona").value || "";
        el.innerHTML = personas.map((p) => {
          const active = p.id === current ? "active" : "";
          return `<button class="secondary ${active}" onclick="selectPersona('${p.id}')">${p.label || p.id}</button>`;
        }).join("");
      }

      async function selectPersona(id) {
        document.getElementById("persona").value = id;
        await setPersona();
        renderPersonaList();
      }

      function renderSessions(events) {
        const el = document.getElementById("session-list");
        const items = (events || []).slice(0, 6);
        el.innerHTML = items.map((e) => {
          const t = e.event_type || "event";
          return `<div class="session"><strong>${t}</strong></div>`;
        }).join("");
      }

      function renderSources(items) {
        const el = document.getElementById("sources");
        if (!items.length) {
          el.innerHTML = "<div class='event'>No sources indexed.</div>";
          return;
        }
        el.innerHTML = items.map((s) => {
          const name = (s.source || "").split(/[\\/]/).slice(-1)[0] || s.source;
          return `
            <div class="source-card">
              <div class="source-icon">${name.slice(0,1).toUpperCase()}</div>
              <div>
                <strong>${name}</strong>
                <div class="source-meta">${s.source}</div>
                <div class="source-meta">chunks=${s.chunks} rank=${(s.avg_rank || 0).toFixed(2)}</div>
              </div>
            </div>`;
        }).join("");
      }

      function toggleSheet(show) {
        const sheet = document.getElementById("sheet");
        const overlay = document.getElementById("overlay");
        const open = show === undefined ? !sheet.classList.contains("open") : show;
        sheet.classList.toggle("open", open);
        overlay.classList.toggle("show", open);
      }

      function toggleBrain(show) {
        const brain = document.getElementById("brain");
        const open = show === undefined ? !brain.classList.contains("show") : show;
        brain.classList.toggle("show", open);
      }

      function renderBrain(graph) {
        const svg = document.getElementById("brain-svg");
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        const nodes = graph.nodes || [];
        const edges = graph.edges || [];
        const width = svg.clientWidth || 800;
        const height = svg.clientHeight || 420;
        if (!svg.__view) {
          svg.__view = { x: 0, y: 0, k: 1, dragging: false, startX: 0, startY: 0 };
        }
        svg.setAttribute("viewBox", `${-width/2} ${-height/2} ${width} ${height}`);
        const centerX = 0;
        const centerY = 0;
        const radius = Math.min(width, height) / 3;
        const positions = {};
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        svg.appendChild(g);
        nodes.forEach((n, i) => {
          const angle = (i / Math.max(1, nodes.length)) * Math.PI * 2;
          positions[n.id] = {
            x: centerX + Math.cos(angle) * radius,
            y: centerY + Math.sin(angle) * radius,
          };
        });
        edges.forEach((e) => {
          const s = positions[e.source];
          const t = positions[e.target];
          if (!s || !t) return;
          const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          line.setAttribute("x1", s.x);
          line.setAttribute("y1", s.y);
          line.setAttribute("x2", t.x);
          line.setAttribute("y2", t.y);
          line.setAttribute("stroke", "#1b7f6b");
          line.setAttribute("stroke-width", Math.max(1, e.count / 2));
          g.appendChild(line);
        });
        nodes.forEach((n) => {
          const pos = positions[n.id];
          const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("cx", pos.x);
          circle.setAttribute("cy", pos.y);
          circle.setAttribute("r", 18);
          circle.setAttribute("fill", n.type === "local" ? "#ff8a3d" : "#3c5ccf");
          g.appendChild(circle);
          const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
          label.setAttribute("x", pos.x);
          label.setAttribute("y", pos.y + 4);
          label.setAttribute("text-anchor", "middle");
          label.setAttribute("fill", "#fff");
          label.setAttribute("font-size", "12");
          label.textContent = n.label;
          g.appendChild(label);
        });
        applyTransform();
      }

      function applyTransform() {
        const svg = document.getElementById("brain-svg");
        const g = svg.querySelector("g");
        if (!g || !svg.__view) return;
        const v = svg.__view;
        g.setAttribute("transform", `translate(${v.x}, ${v.y}) scale(${v.k})`);
      }

      (function setupBrainInteractions() {
        const svg = document.getElementById("brain-svg");
        svg.addEventListener("wheel", (e) => {
          e.preventDefault();
          if (!svg.__view) return;
          const delta = e.deltaY < 0 ? 1.1 : 0.9;
          svg.__view.k = Math.min(3, Math.max(0.3, svg.__view.k * delta));
          applyTransform();
        });
        svg.addEventListener("mousedown", (e) => {
          if (!svg.__view) return;
          svg.__view.dragging = true;
          svg.__view.startX = e.clientX;
          svg.__view.startY = e.clientY;
        });
        window.addEventListener("mousemove", (e) => {
          if (!svg.__view || !svg.__view.dragging) return;
          const dx = (e.clientX - svg.__view.startX);
          const dy = (e.clientY - svg.__view.startY);
          svg.__view.startX = e.clientX;
          svg.__view.startY = e.clientY;
          svg.__view.x += dx;
          svg.__view.y += dy;
          applyTransform();
        });
        window.addEventListener("mouseup", () => {
          if (svg.__view) svg.__view.dragging = false;
        });
      })();

      function extractArtifacts(events) {
        for (const e of events) {
          if (!e || !e.payload) continue;
          const payload = e.payload.payload || e.payload;
          const text = typeof payload === "string" ? payload : JSON.stringify(payload);
          const match = text.match(/```(html|svg)([\\s\\S]*?)```/i);
          if (match) {
            return { type: match[1].toLowerCase(), content: match[2].trim() };
          }
        }
        return null;
      }

      function extractUI(payload) {
        const raw = typeof payload === "string" ? payload : JSON.stringify(payload);
        const fenced = raw.match(/```ui([\\s\\S]*?)```/i);
        if (fenced) {
          try { return JSON.parse(fenced[1]); } catch { return null; }
        }
        const inline = raw.match(/\\\"ui\\\"\\s*:\\s*(\\{[\\s\\S]*\\})/i);
        if (inline) {
          try { return JSON.parse(inline[1]); } catch { return null; }
        }
        return null;
      }

      function renderUICard(ui) {
        if (!ui || typeof ui !== "object") return "";
        if (ui.type === "flight_card") {
          return `
            <div class="ui-card">
              <h4>Flight</h4>
              <div class="ui-row"><strong>${ui.from} → ${ui.to}</strong></div>
              <div class="ui-row">Date: ${ui.date || "TBD"}</div>
              <div class="ui-row">Price: ${ui.price || "—"}</div>
              <button class="secondary">Select</button>
            </div>`;
        }
        if (ui.type === "date_picker") {
          return `
            <div class="ui-card">
              <h4>Date Picker</h4>
              <div class="ui-row">
                <input type="date" />
                <button class="secondary">Apply</button>
              </div>
            </div>`;
        }
        return `<div class="ui-card"><pre class="mono">${JSON.stringify(ui, null, 2)}</pre></div>`;
      }

      function showArtifact(mode) {
        const preview = document.getElementById("artifact-preview");
        const raw = document.getElementById("artifacts");
        if (mode === "preview") {
          preview.style.display = "block";
          raw.style.display = "none";
        } else {
          preview.style.display = "none";
          raw.style.display = "block";
        }
      }

      async function refresh() {
        const cockpit = await fetch("/api/cockpit").then((r) => r.json());
        renderEvents(cockpit.events || []);
        renderA2A(cockpit.a2a || []);
        renderSessions(cockpit.events || []);
        const metrics = cockpit.metrics || {};
        document.getElementById("status-metrics").textContent = `Metrics: ${Object.keys(metrics).length}`;
        document.getElementById("status-events").textContent = `Events: ${cockpit.events ? cockpit.events.length : 0}`;
        const tools = await fetch("/api/tools").then((r) => r.json());
        renderTools(tools || []);
        const sources = await fetch("/api/rag_sources").then((r) => r.json());
        renderSources(sources || []);
        const cfg = await fetch("/api/config").then((r) => r.json());
        document.getElementById("config-edit").value = JSON.stringify(cfg, null, 2);
        const log = await fetch("/api/log_tail").then((r) => r.json());
        document.getElementById("terminal").textContent = (log.lines || []).join("\\n");
        const hud = await fetch("/api/vla_latest").then((r) => r.json());
        if (hud.image) {
          document.getElementById("hud-image").src = hud.image;
        }
        const graph = await fetch("/api/graph").then((r) => r.json());
        renderBrain(graph || {});
        renderPersonaList();

        const artifact = extractArtifacts(cockpit.events || []);
        if (artifact) {
          document.getElementById("artifacts").textContent = artifact.content;
          document.getElementById("artifact-frame").srcdoc = artifact.content;
          showArtifact("preview");
        }
      }

      async function loadConfig() {
        const cfg = await fetch("/api/config").then((r) => r.json());
        document.getElementById("config-edit").value = JSON.stringify(cfg, null, 2);
      }

      async function saveConfig() {
        let updates = {};
        try {
          updates = JSON.parse(document.getElementById("config-edit").value || "{}");
        } catch {
          alert("Invalid JSON");
          return;
        }
        await fetch("/api/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ updates }),
        });
      }

      setInterval(refresh, 2000);
      refresh();
    </script>
  </body>
</html>
